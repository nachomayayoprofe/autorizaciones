<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Autorizaci칩n Ba침o</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: 'Verdana', sans-serif;
  background-color: #f0f2f5;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding-top: 50px;
}

.container {
  background-color: #ffffff;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  width: 350px;
  max-width: 90%;
}

h2 {
  text-align: center;
  margin-bottom: 20px;
  color: #333;
}

select, button {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

select:disabled, button:disabled {
  background-color: #e9e9e9;
  cursor: not-allowed;
}

button {
  background-color: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
}

button:hover:not(:disabled) {
  background-color: #45a049;
}

.contador {
  text-align: center;
  margin-top: 15px;
  font-size: 16px;
  font-weight: bold;
}

#mensaje {
  text-align: center;
  margin-top: 10px;
  font-weight: bold;
  color: #0066cc;
}
</style>

</head>

<body>
<div class="container">
<h2>Autorizaci칩n Ba침o</h2>

<select id="curso">
  <option value="">Selecciona curso</option>
</select>

<select id="clase" disabled>
  <option value="">Selecciona clase</option>
</select>

<select id="alumno" disabled>
  <option value="">Selecciona alumno</option>
</select>

<div class="contador" id="veces">Veces hoy: 0</div>

<button id="autorizar" disabled>Autorizar</button>
<p id="mensaje"></p>
</div>

<script>
// 游댳 FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyCAU3XI25r45i4d4zyWWxLNvKrTkg0Gs3s",
  authDomain: "autorizaciones-cc9cd.firebaseapp.com",
  projectId: "autorizaciones-cc9cd",
  databaseURL: "https://autorizaciones-cc9cd-default-rtdb.europe-west1.firebasedatabase.app",
  storageBucket: "autorizaciones-cc9cd.firebasestorage.app",
  messagingSenderId: "126656366989",
  appId: "1:126656366989:web:57b69507cf2eb84e1995c4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 游댳 ALUMNOS
const alumnos = [
  {curso:"1췈 ESO", grupo:"A", nombre:"Ana"},
  {curso:"1췈 ESO", grupo:"A", nombre:"Luis"},
  {curso:"2췈 ESO", grupo:"B", nombre:"Carlos"}
];

const cursoSel = document.getElementById("curso");
const claseSel = document.getElementById("clase");
const alumnoSel = document.getElementById("alumno");
const btn = document.getElementById("autorizar");
const vecesDiv = document.getElementById("veces");
const msg = document.getElementById("mensaje");

let alumnoActual = null;

// 游댳 CARGA CURSOS
[...new Set(alumnos.map(a=>a.curso))].forEach(c=>{
  cursoSel.innerHTML += `<option value="${c}">${c}</option>`;
});

cursoSel.onchange = () => {
  claseSel.innerHTML = '<option value="">Selecciona clase</option>';
  alumnoSel.innerHTML = '<option value="">Selecciona alumno</option>';
  claseSel.disabled = true;
  alumnoSel.disabled = true;
  btn.disabled = true;
  vecesDiv.innerText = "Veces hoy: 0";
  msg.innerText = "";

  if(!cursoSel.value) return;

  [...new Set(alumnos.filter(a=>a.curso===cursoSel.value).map(a=>a.grupo))]
  .forEach(g=>{
    claseSel.innerHTML += `<option value="${g}">${g}</option>`;
  });
  claseSel.disabled = false;
};

claseSel.onchange = () => {
  alumnoSel.innerHTML = '<option value="">Selecciona alumno</option>';
  alumnoSel.disabled = true;
  btn.disabled = true;
  vecesDiv.innerText = "Veces hoy: 0";
  msg.innerText = "";

  if(!claseSel.value) return;

  alumnos
    .filter(a=>a.curso===cursoSel.value && a.grupo===claseSel.value)
    .forEach(a=>{
      alumnoSel.innerHTML += `<option value="${a.nombre}">${a.nombre}</option>`;
    });
  alumnoSel.disabled = false;
};

alumnoSel.onchange = () => {
  alumnoActual = alumnoSel.value;
  btn.disabled = !alumnoActual;
  msg.innerText = "";

  if(!alumnoActual) return;

  const hoy = new Date().toISOString().slice(0,10);

  db.ref(`autorizaciones/${hoy}/${alumnoActual}`).once("value")
    .then(snap=>{
      const veces = snap.exists() ? snap.val().length : 0;
      vecesDiv.innerText = "Veces hoy: " + veces;
    });
};

// 游댳 AUTORIZAR
btn.onclick = () => {
  if(!alumnoActual) return;

  const ahora = new Date();
  const hoy = ahora.toISOString().slice(0,10);
  const hora = ahora.toTimeString().slice(0,5);

  const ref = db.ref(`autorizaciones/${hoy}/${alumnoActual}`);

  ref.once("value").then(snap=>{
    const datos = snap.exists() ? snap.val() : [];
    datos.push({ hora: hora });
    ref.set(datos);

    vecesDiv.innerText = "Veces hoy: " + datos.length;
    msg.innerText = `Autorizado a las ${hora}`;
  });
};
</script>
</body>
</html>

